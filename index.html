<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ So sánh và Lọc Excel (2 File)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-label:hover { background-color: #eef2ff; border-color: #4f46e5; }
        .hidden { display: none; }
        .step-header {
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            color: #3730a3;
        }
        .action-link {
            @apply text-sm text-indigo-600 hover:text-indigo-800 font-medium cursor-pointer;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Công cụ So sánh và Lọc Excel</h1>
            <p class="mt-2 text-gray-600">Hỗ trợ quy trình làm việc với 2 file, có bộ lọc và tùy chọn cột.</p>
        </header>

        <!-- Step 1: Upload Files -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
            <h2 class="text-2xl font-bold step-header">Bước 1: Tải các File lên</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- File 1 -->
                <div>
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">File 1: File Nguồn (Lọc)</h3>
                    <label for="file1" class="border-2 border-dashed border-gray-300 rounded-lg p-4 block cursor-pointer file-input-label"><span id="file1-name">Chọn File 1</span></label>
                    <input type="file" id="file1" class="hidden" accept=".xlsx, .xls, .csv">
                    <select id="sheet1" class="w-full p-2 border border-gray-300 rounded-md mt-2 hidden"></select>
                </div>
                <!-- File 2 -->
                <div>
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">File 2: Dữ liệu chính</h3>
                    <label for="file2" class="border-2 border-dashed border-gray-300 rounded-lg p-4 block cursor-pointer file-input-label"><span id="file2-name">Chọn File 2</span></label>
                    <input type="file" id="file2" class="hidden" accept=".xlsx, .xls, .csv">
                    <select id="sheet2" class="w-full p-2 border border-gray-300 rounded-md mt-2 hidden"></select>
                </div>
            </div>
        </div>

        <!-- Step 2: Configuration -->
        <div id="config-section" class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hidden">
            <h2 class="text-2xl font-bold step-header">Bước 2: Cấu hình Lọc và So sánh</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                <!-- Config File 1 -->
                <div id="config-file1">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-4">Cấu hình File 1</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="key1" class="font-medium">Cột so sánh chính:</label>
                            <select id="key1" class="w-full p-2 border border-gray-300 rounded-md mt-1"></select>
                        </div>
                        <div class="pt-4 border-t">
                             <input type="checkbox" id="enable-filter1" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                             <label for="enable-filter1" class="ml-2 font-medium">Lọc File 1 trước khi so sánh</label>
                             <div id="filter1-controls" class="space-y-2 mt-2 hidden pl-6">
                                <select id="filter1-column" class="w-full p-2 border border-gray-300 rounded-md" title="Cột cần lọc"></select>
                                <select id="filter1-value" class="w-full p-2 border border-gray-300 rounded-md" title="Giá trị cần lọc"></select>
                             </div>
                        </div>
                    </div>
                </div>
                <!-- Config File 2 -->
                <div id="config-file2">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-4">Cấu hình File 2</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="key2" class="font-medium">Cột để so sánh với File 1:</label>
                            <select id="key2" class="w-full p-2 border border-gray-300 rounded-md mt-1"></select>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label class="font-medium">Các cột cần lấy từ File 2:</label>
                                <div class="space-x-2">
                                    <span id="select-all-2" class="action-link">Chọn tất cả</span>
                                    <span id="deselect-all-2" class="action-link">Bỏ chọn</span>
                                </div>
                            </div>
                            <div id="output-columns-list2" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-lg mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Action -->
        <div class="mt-8 text-center">
            <button id="process-btn" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-300" disabled>
                Xử lý và Tải kết quả
            </button>
            <div id="status" class="mt-4 text-gray-600 min-h-[24px]"></div>
        </div>
    </div>

<script>
// --- DOM Elements ---
const fileInputs = { 1: document.getElementById('file1'), 2: document.getElementById('file2') };
const fileNames = { 1: document.getElementById('file1-name'), 2: document.getElementById('file2-name') };
const sheetSelects = { 1: document.getElementById('sheet1'), 2: document.getElementById('sheet2') };
const keySelects = { 1: document.getElementById('key1'), 2: document.getElementById('key2') };
const configSection = document.getElementById('config-section');
const processBtn = document.getElementById('process-btn');
const statusDiv = document.getElementById('status');
// Filter 1
const enableFilter1Checkbox = document.getElementById('enable-filter1');
const filter1Controls = document.getElementById('filter1-controls');
const filter1ColumnSelect = document.getElementById('filter1-column');
const filter1ValueSelect = document.getElementById('filter1-value');
// Output 2
const outputColumnsList2 = document.getElementById('output-columns-list2');
const selectAll2Btn = document.getElementById('select-all-2');
const deselectAll2Btn = document.getElementById('deselect-all-2');

// --- State ---
let workbooks = { 1: null, 2: null };
let sheetData = { 1: null, 2: null };
let sheetHeaders = { 1: [], 2: [] };

// --- Functions ---

const handleFile = (file, fileNum) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        workbooks[fileNum] = XLSX.read(data, { type: 'array' });
        fileNames[fileNum].textContent = file.name;
        fileNames[fileNum].classList.add('text-indigo-700', 'font-semibold');
        populateSheetSelect(fileNum);
        checkConfigReady();
    };
    reader.readAsArrayBuffer(file);
};

const populateSheetSelect = (fileNum) => {
    const select = sheetSelects[fileNum];
    select.innerHTML = '<option value="" disabled selected>-- Chọn sheet --</option>';
    workbooks[fileNum].SheetNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });
    select.classList.remove('hidden');
};

const loadSheetData = (fileNum, sheetName) => {
    if (!sheetName) {
        sheetData[fileNum] = null;
        sheetHeaders[fileNum] = [];
    } else {
        const worksheet = workbooks[fileNum].Sheets[sheetName];
        sheetData[fileNum] = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
        sheetHeaders[fileNum] = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0] || [];
    }
    updateConfigUI();
    checkConfigReady();
};

const updateConfigUI = () => {
    if (sheetData[1]) {
        populateColumnSelect(keySelects[1], sheetHeaders[1]);
        populateColumnSelect(filter1ColumnSelect, sheetHeaders[1]);
    }
    if (sheetData[2]) {
        populateColumnSelect(keySelects[2], sheetHeaders[2]);
        populateCheckboxList(outputColumnsList2, sheetHeaders[2]);
    }
};

const checkConfigReady = () => {
    const ready = !!(sheetData[1] && sheetData[2]);
    configSection.classList.toggle('hidden', !ready);
    processBtn.disabled = !ready;
};

const populateColumnSelect = (select, headers, placeholder = '-- Chọn cột --') => {
    const currentValue = select.value;
    select.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
    headers.forEach(h => {
        if (h) select.add(new Option(h, h));
    });
    if (headers.includes(currentValue)) {
        select.value = currentValue;
    }
};

/**
 * [FIXED] Refactored this function to be more robust.
 * Instead of using innerHTML in a loop, it builds the elements
 * in a document fragment before appending them to the DOM once.
 */
const populateCheckboxList = (container, headers) => {
    container.innerHTML = ''; // Clear previous list
    const fragment = document.createDocumentFragment();
    headers.forEach(h => {
        if (h) {
            const id = `cb-${container.id}-${h.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            const div = document.createElement('div');
            div.className = 'flex items-center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = h;
            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
            checkbox.checked = true;

            const label = document.createElement('label');
            label.htmlFor = id;
            label.className = 'ml-2 text-sm truncate';
            label.title = h;
            label.textContent = h;

            div.appendChild(checkbox);
            div.appendChild(label);
            fragment.appendChild(div);
        }
    });
    container.appendChild(fragment);
};

const getSelectedCheckboxValues = (container) => Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);

const setAllCheckboxes = (container, checked) => {
    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
};

const processFiles = () => {
    statusDiv.textContent = 'Đang xử lý...';
    processBtn.disabled = true;

    setTimeout(() => {
        try {
            // 1. Filter File 1 data
            let data1 = sheetData[1];
            if (enableFilter1Checkbox.checked) {
                const col = filter1ColumnSelect.value;
                const val = filter1ValueSelect.value;
                if (!col || !val) throw new Error("Vui lòng chọn cột và giá trị để lọc ở File 1.");
                data1 = data1.filter(row => String(row[col]).trim() === String(val).trim());
            }

            // 2. Join File 1 and File 2
            const key1 = keySelects[1].value;
            const key2 = keySelects[2].value;
            const outputCols2 = getSelectedCheckboxValues(outputColumnsList2);
            if (!key1 || !key2 || outputCols2.length === 0) throw new Error("Vui lòng cấu hình đầy đủ cho File 1 và File 2.");

            const data1KeySet = new Set(data1.map(row => row[key1]?.toString().trim()).filter(Boolean));
            let finalResult = sheetData[2]
                .filter(row => data1KeySet.has(row[key2]?.toString().trim()))
                .map(row => {
                    let newRow = {};
                    outputCols2.forEach(col => newRow[col] = row[col]);
                    return newRow;
                });

            if (finalResult.length === 0) {
                statusDiv.textContent = 'Không tìm thấy dòng nào khớp.';
            } else {
                const ws = XLSX.utils.json_to_sheet(finalResult);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'KetQua');
                XLSX.writeFile(wb, 'KetQuaSoSanh.xlsx');
                statusDiv.textContent = `Xử lý thành công ${finalResult.length} dòng. Đã tải file kết quả.`;
            }

        } catch (e) {
            statusDiv.textContent = `Lỗi: ${e.message}`;
        } finally {
            processBtn.disabled = false;
        }
    }, 50);
};

// --- Event Listeners ---
Object.keys(fileInputs).forEach(num => {
    fileInputs[num].addEventListener('change', (e) => handleFile(e.target.files[0], num));
    sheetSelects[num].addEventListener('change', (e) => loadSheetData(num, e.target.value));
});

enableFilter1Checkbox.addEventListener('change', (e) => filter1Controls.classList.toggle('hidden', !e.target.checked));
filter1ColumnSelect.addEventListener('change', (e) => {
    const col = e.target.value;
    if (!col || !sheetData[1]) return;
    const uniqueValues = [...new Set(sheetData[1].map(row => row[col]).filter(v => v != null))].sort();
    populateColumnSelect(filter1ValueSelect, uniqueValues, '-- Chọn giá trị --');
});

selectAll2Btn.addEventListener('click', () => setAllCheckboxes(outputColumnsList2, true));
deselectAll2Btn.addEventListener('click', () => setAllCheckboxes(outputColumnsList2, false));

processBtn.addEventListener('click', processFiles);

</script>
</body>
</html>
